<template>
  <div class="message-log">
    <div v-if="msg.length > 0">
      <infinite-loading
        v-if="sortDirection === 'bottom'"
        direction="top"
        @infinite="infiniteHandler"
      >
      </infinite-loading>
      <div
        v-for="message in msg"
        :key="message.messageId"
        class="chat-item"
        :class="[
          msg[0]._sender.nickname === message.sender.nickname
            ? 'me'
            : 'stranger',
        ]"
        :style="{
          'background-color':
            msg[0]._sender.nickname === message.sender.nickname
              ? config.themeColor
              : '',
          color:
            msg[0]._sender.nickname === message.sender.nickname &&
            config.themeColor === '#1d77ff'
              ? '#fff'
              : '',
        }"
      >
        <p v-if="message.sender.userId !== userId" class="nickname">
          {{ message.sender.nickname }}
        </p>

        <div style="white-space: pre-wrap">{{ message.message }}</div>

        <img
          v-if="message.url && checkType(message.url.toString())"
          class="file-img"
          v-bind:src="message.url"
        />

        <img
          v-if="message.url && !checkType(message.url.toString())"
          class="file-file"
          src="@/assets/file.png"
        />
        <a
          v-if="message.url && !checkType(message.url.toString())"
          class="file-filename"
          :href="message.url"
        >
          {{ message.url }}
        </a>

        <time>{{ convertDate(message.createdAt) }}</time>
      </div>

      <infinite-loading
        v-if="sortDirection === 'top'"
        direction="bottom"
        @infinite="infiniteHandler"
      >
      </infinite-loading>
    </div>
  </div>
</template>
<!-- 
<p>{{ convertDate(message.createdAt) }}</p>
 <button @click="more" v-if="messages.hasMoreMessage">더보기</button>
 const chat = document.querySelector(
        ".chat-container li:nth-child(4) div"
      );
  nickname 과 message.nickname이 같을 때 list에 class를 준다
  어떻게 줄것? 
-->
<script>
import { format } from 'date-fns';
import InfiniteLoading from 'vue-infinite-loading';
import { SendbirdAction } from '@/sendbird/SendbirdAction';

export default {
  components: {
    InfiniteLoading,
  },

  name: 'MessageLog',

  props: {
    sortDirection: {
      type: String,
      default: 'top',
    },
    classValue: {
      type: Boolean,
      default: false,
    },
    userId: {
      type: String,
      default: 'admin',
    },
    nickname: {
      type: String,
      default: 'nickname',
    },
  },

  inject: {
    config: {
      themeColor: '#1d77ff',
    },
    msg: 'msg',
  },

  data() {
    return {
      isReverse: false,
      messages: [],
      loadMessage: 30,
      timestamp: 0,
    };
  },

  methods: {
    convertDate(date) {
      return format(date, 'yyyy-MM-dd HH:mm');
    },

    checkType(fileUrl) {
      if (
        fileUrl.includes('jpeg') ||
        fileUrl.includes('png') ||
        fileUrl.includes('jpg')
      ) {
        return true;
      } else {
        return false;
      }
    },

    infiniteHandler($state) {
      const sendbirdAction = SendbirdAction.getInstance();
      const direction = this.sortDirection === 'top' ? true : false;
      console.log(direction);
      setTimeout(() => {
        sendbirdAction
          .getMessageList(this.loadMessage, direction)
          .then((res) => {
            if (direction) {
              this.msg.push(...res);
            } else if (!direction) {
              this.msg.unshift(...res);
            }
            // this.loadMessage += 20;
            //const newItemList = this.messages.push(...res);
            // this.msg.unshift(...res);

            $state.loading();
          })
          .catch(() => {
            $state.complete();
          });
      }, 1000);
    },
  },

  //어떻게 비교하느냐. -> 현재 userId 파악 -> itemList를 순회해서 msg.itemList[0]._sender.userId이
  //this.userId와 다르면 각각 다른  요소에 class를 준다. userId = userId 이면 .me
  //다르면 stranger
  // if (this.nickname === this.messages[0]._sender.nickname) {
  //    console.log("dd");
  //  }
};
</script>

<style scoped>
.message-log {
  padding: 20px 15px;
}
.file-img {
  width: 150px;
}

.file-file {
  width: 30px;
}

.file-filename {
  font-size: 15px;
}

.chat-item {
  position: relative;
  width: 200px;
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 15px;
  list-style-type: none;
  word-break: break-all;
}

.chat-item .nickname {
  margin: 0 0 10px;
  font-weight: bold;
}

.chat-item time {
  display: block;
  opacity: 0.5;
  margin: 10px 0 0;
  font-size: 12px;
}

.me {
  float: right;
  margin-left: 20px;
  background: white;
}

.stranger {
  float: left;
  margin-right: 20px;
  background: white;
}
</style>
